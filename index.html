<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>FAE Lab é›»æºä½¿ç”¨ç®¡ç†ç³»çµ±</title>
  <style>
    /* ä½ çš„ CSS ä¸éœ€è®Šå‹•ï¼Œç•¥å»é¡¯ç¤º */
  </style>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyCThrykIH-kRHVao0rFQnnhEOhn9lVTN0I",
      authDomain: "fae-lab-power-management.firebaseapp.com",
      projectId: "fae-lab-power-management",
      storageBucket: "fae-lab-power-management.appspot.com",
      messagingSenderId: "237708362565",
      appId: "1:237708362565:web:cff14a2236ba77586cf42c",
      measurementId: "G-S5ZP7D3DBG"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    console.log("âœ… Firebase å·²åˆå§‹åŒ–");

    const socketNames = [];
    for (let i = 1; i <= 15; i++) socketNames.push("P" + i);
    for (let i = 1; i <= 8; i++) socketNames.push("A" + i);

    const gridDiv = document.createElement('div');
    gridDiv.className = 'grid';

    document.addEventListener('DOMContentLoaded', () => {
      const title = document.createElement('h2');
      title.textContent = 'FAE Lab é›»æºä½¿ç”¨ç®¡ç†ç³»çµ±';
      document.body.appendChild(title);

      const rulesDiv = document.createElement('div');
      rulesDiv.id = 'rules';
      rulesDiv.innerHTML = `
        <p>è«‹è¼¸å…¥å§“åã€ç”¨é€”ã€ç³»çµ±åç¨±ï¼Œå¾Œé»é¸æƒ³è¦ä½¿ç”¨çš„å°æ‡‰æ’åº§ã€‚<br/>
        GPU stress æ¸¬è©¦è«‹è©³ç´°å¡«å¯«ä½¿ç”¨ GPU å‹è™Ÿèˆ‡ç”¨é€”ã€‚</p>
        <img src="https://i.postimg.cc/T2zvM9VW/rule.png" alt="ä½¿ç”¨è¦å‰‡ç¤ºæ„åœ–" style="max-width:100%; margin-top:15px; border-radius:8px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);" />
      `;
      document.body.appendChild(rulesDiv);

      const inputDiv = document.createElement('div');
      inputDiv.id = 'input-area';
      inputDiv.innerHTML = `
        <label>å§“åï¼š<input type="text" id="name" required></label>
        <label>ç”¨é€”ï¼š<input type="text" id="purpose" required></label>
        <label>ç³»çµ±åç¨±ï¼š<input type="text" id="system" required></label>
      `;
      document.body.appendChild(inputDiv);
      document.body.appendChild(gridDiv);

      init();
    });

    let currentUseDocs = {};

    function formatTimestamp(ts) {
      if (!ts || !ts.toDate) return '';
      const d = ts.toDate();
      return `${d.getFullYear()}-${String(d.getMonth() + 1).padStart(2, '0')}-${String(d.getDate()).padStart(2, '0')} ` +
             `${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}:${String(d.getSeconds()).padStart(2, '0')}`;
    }

    function init() {
      gridDiv.innerHTML = '';
      socketNames.forEach(name => {
        const box = document.createElement('div');
        box.className = 'socket-box available';
        box.dataset.socket = name;

        const info = document.createElement('div');
        info.className = 'info-text';
        info.textContent = `${name}\n(ç©ºé–’)`;
        box.appendChild(info);

        gridDiv.appendChild(box);
      });

      // ğŸ” Firestore ç›£è½å™¨ + éŒ¯èª¤è¿½è¹¤
      db.collection('sockets')
        .orderBy('timestamp', 'desc')
        .onSnapshot(snapshot => {
          console.log("ğŸ“¡ ç›£è½æ›´æ–°ï¼Œå…±æœ‰ç­†æ•¸ï¼š", snapshot.size);
          snapshot.docChanges().forEach(change => {
            const doc = change.doc;
            const data = doc.data();
            const socketName = data.socket;
            const box = [...gridDiv.children].find(b => b.dataset.socket === socketName);
            if (!box) return;

            if (change.type === 'added' || change.type === 'modified') {
              box.classList.remove('available');
              box.classList.add('used');

              box.innerHTML = '';
              const info = document.createElement('div');
              info.className = 'info-text';
              info.innerHTML = `${socketName}<br>${data.name}<br>${data.purpose}<br>${data.system}<br><small>${formatTimestamp(data.timestamp)}</small>`;
              box.appendChild(info);

              const btn = document.createElement('button');
              btn.className = 'cancel-btn';
              btn.textContent = 'å–æ¶ˆä½¿ç”¨';
              btn.dataset.id = doc.id;
              box.appendChild(btn);

              currentUseDocs[socketName] = doc.id;
            } else if (change.type === 'removed') {
              box.classList.remove('used');
              box.classList.add('available');
              box.innerHTML = '';
              const info = document.createElement('div');
              info.className = 'info-text';
              info.textContent = socketName + '\n(ç©ºé–’)';
              box.appendChild(info);
              delete currentUseDocs[socketName];
            }
          });

          attachCancelButtons();
        }, error => {
          console.error("âŒ Firestore è¨‚é–±éŒ¯èª¤ï¼š", error);
        });
    }

    // ğŸ”„ ä½¿ç”¨æ’åº§äº‹ä»¶
    document.addEventListener('click', async e => {
      const socketBox = e.target.closest('.socket-box');
      if (socketBox && socketBox.classList.contains('available')) {
        const socket = socketBox.dataset.socket;
        const name = document.getElementById('name').value.trim();
        const purpose = document.getElementById('purpose').value.trim();
        const system = document.getElementById('system').value.trim();

        if (!name || !purpose || !system) {
          alert('è«‹å…ˆè¼¸å…¥å§“åã€ç”¨é€”ã€ç³»çµ±åç¨±');
          return;
        }

        if (currentUseDocs[socket]) {
          alert('æ­¤æ’åº§å·²è¢«ä½¿ç”¨');
          return;
        }

        try {
          await db.collection('sockets').add({
            socket,
            name,
            purpose,
            system,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
          });
          console.log("âœ… å¯«å…¥æˆåŠŸ");
          alert('ç™»è¨˜æˆåŠŸï¼');
        } catch (err) {
          console.error("âŒ å¯«å…¥éŒ¯èª¤ï¼š", err);
          alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
        }
      }
    });

    // â›”ï¸ å–æ¶ˆä½¿ç”¨æ’åº§
    function attachCancelButtons() {
      const buttons = document.querySelectorAll('.cancel-btn');
      buttons.forEach(btn => {
        btn.onclick = async e => {
          e.stopPropagation();
          if (confirm('ç¢ºå®šè¦å–æ¶ˆä½¿ç”¨å—ï¼Ÿ')) {
            const docId = btn.dataset.id;
            try {
              await db.collection('sockets').doc(docId).delete();
              alert('å·²å–æ¶ˆä½¿ç”¨');
            } catch (err) {
              alert('å–æ¶ˆå¤±æ•—');
              console.error(err);
            }
          }
        };
      });
    }
  </script>
</head>
<body></body>
</html>
